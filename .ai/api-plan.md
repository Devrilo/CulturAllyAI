# REST API Plan - CulturAllyAI

## 1. Resources

| Resource | Database Table | Description |
|----------|---------------|-------------|
| Auth | auth.users | User authentication and account management |
| Events | events | Cultural event descriptions generated by AI |
| User Activity Logs | user_activity_logs | Audit logs for user account actions |
| Event Management Logs | event_management_logs | Audit logs for event-related actions |

## 2. Endpoints

### 2.1 Events

#### Generate Event Description

- **Method:** `POST`
- **Path:** `/api/events`
- **Description:** Create a new event with AI-generated description
- **Authentication:** Optional (Bearer token for authenticated users)
- **Request Body:**
```json
{
  "title": "Koncert Chopina",
  "city": "Warszawa",
  "event_date": "2025-12-15",
  "category": "koncerty",
  "age_category": "dorosli",
  "key_information": "Koncert muzyki klasycznej w wykonaniu Filharmonii Narodowej"
}
```
- **Success Response (201 Created):**
```json
{
  "id": "uuid",
  "user_id": "uuid or null",
  "created_by_authenticated_user": true,
  "title": "Koncert Chopina",
  "city": "Warszawa",
  "event_date": "2025-12-15",
  "category": "koncerty",
  "age_category": "dorosli",
  "key_information": "Koncert muzyki klasycznej w wykonaniu Filharmonii Narodowej",
  "generated_description": "Zapraszamy na niezapomniany koncert muzyki Chopina...",
  "edited_description": null,
  "saved": false,
  "feedback": null,
  "model_version": "gpt-4",
  "created_at": "2025-10-17T10:30:00Z",
  "updated_at": "2025-10-17T10:30:00Z"
}
```
- **Error Responses:**
  - `400 Bad Request`: Validation errors (character limits, invalid date, invalid enum values)
  - `500 Internal Server Error`: AI generation failed
  - `503 Service Unavailable`: AI service timeout

#### Get User Events

- **Method:** `GET`
- **Path:** `/api/events`
- **Description:** Retrieve user's events with filtering and pagination
- **Authentication:** Required (Bearer token)
- **Query Parameters:**
  - `saved` (boolean): Filter by saved status
  - `category` (string, optional): Filter by event category
  - `age_category` (string, optional): Filter by age category
  - `page` (integer, optional, default: 1): Page number
  - `limit` (integer, optional, default: 20, max: 100): Items per page
  - `sort` (string, optional, default: "created_at"): Sort field (created_at, event_date, title)
  - `order` (string, optional, default: "desc"): Sort order (asc, desc)
- **Success Response (200 OK):**
```json
{
  "data": [
    {
      "id": "uuid",
      "title": "Koncert Chopina",
      "city": "Warszawa",
      "event_date": "2025-12-15",
      "category": "koncerty",
      "age_category": "dorosli",
      "key_information": "Koncert muzyki klasycznej...",
      "generated_description": "Zapraszamy na niezapomniany koncert...",
      "edited_description": null,
      "saved": true,
      "feedback": "thumbs_up",
      "created_at": "2025-10-17T10:30:00Z",
      "updated_at": "2025-10-17T10:35:00Z"
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 45,
    "total_pages": 3
  }
}
```
- **Error Responses:**
  - `401 Unauthorized`: Invalid or expired token
  - `400 Bad Request`: Invalid query parameters

#### Get Event by ID

- **Method:** `GET`
- **Path:** `/api/events/:id`
- **Description:** Retrieve a specific event by ID
- **Authentication:** Required (Bearer token)
- **Path Parameters:**
  - `id` (uuid): Event ID
- **Success Response (200 OK):**
```json
{
  "id": "uuid",
  "user_id": "uuid",
  "created_by_authenticated_user": true,
  "title": "Koncert Chopina",
  "city": "Warszawa",
  "event_date": "2025-12-15",
  "category": "koncerty",
  "age_category": "dorosli",
  "key_information": "Koncert muzyki klasycznej...",
  "generated_description": "Zapraszamy na niezapomniany koncert...",
  "edited_description": "Wyjątkowy koncert Chopina...",
  "saved": true,
  "feedback": "thumbs_up",
  "model_version": "gpt-4",
  "created_at": "2025-10-17T10:30:00Z",
  "updated_at": "2025-10-17T10:35:00Z"
}
```
- **Error Responses:**
  - `401 Unauthorized`: Invalid or expired token
  - `404 Not Found`: Event not found or doesn't belong to user

#### Update Event

- **Method:** `PATCH`
- **Path:** `/api/events/:id`
- **Description:** Update event properties (save, feedback, edited description)
- **Authentication:** Required (Bearer token)
- **Path Parameters:**
  - `id` (uuid): Event ID
- **Request Body (partial update):**
```json
{
  "saved": true,
  "feedback": "thumbs_up",
  "edited_description": "Wyjątkowy koncert Chopina w Filharmonii Narodowej..."
}
```
- **Success Response (200 OK):**
```json
{
  "id": "uuid",
  "user_id": "uuid",
  "title": "Koncert Chopina",
  "saved": true,
  "feedback": "thumbs_up",
  "edited_description": "Wyjątkowy koncert Chopina...",
  "updated_at": "2025-10-17T10:40:00Z"
}
```
- **Error Responses:**
  - `400 Bad Request`: Validation errors (edited_description > 500 chars, invalid feedback value)
  - `401 Unauthorized`: Invalid or expired token
  - `403 Forbidden`: Cannot modify event created by guest user
  - `404 Not Found`: Event not found or doesn't belong to user

#### Delete Event (Soft Delete)

- **Method:** `DELETE`
- **Path:** `/api/events/:id`
- **Description:** Soft delete event by setting saved to false
- **Authentication:** Required (Bearer token)
- **Path Parameters:**
  - `id` (uuid): Event ID
- **Success Response (200 OK):**
```json
{
  "message": "Event removed from saved list",
  "id": "uuid",
}
```
- **Error Responses:**
  - `401 Unauthorized`: Invalid or expired token
  - `404 Not Found`: Event not found or doesn't belong to user

### 2.2 Categories & Enums

#### Get Event Categories

- **Method:** `GET`
- **Path:** `/api/categories/events`
- **Description:** Get list of available event categories
- **Authentication:** Not required
- **Success Response (200 OK):**
```json
{
  "categories": [
    { "value": "koncerty", "label": "Koncerty" },
    { "value": "imprezy", "label": "Imprezy" },
    { "value": "teatr_i_taniec", "label": "Teatr i taniec" },
    { "value": "sztuka_i_wystawy", "label": "Sztuka i wystawy" },
    { "value": "literatura", "label": "Literatura" },
    { "value": "kino", "label": "Kino" },
    { "value": "festiwale", "label": "Festiwale" },
    { "value": "inne", "label": "Inne" }
  ]
}
```

#### Get Age Categories

- **Method:** `GET`
- **Path:** `/api/categories/age`
- **Description:** Get list of available age categories
- **Authentication:** Not required
- **Success Response (200 OK):**
```json
{
  "categories": [
    { "value": "wszystkie", "label": "Wszystkie" },
    { "value": "najmlodsi", "label": "Najmłodsi" },
    { "value": "dzieci", "label": "Dzieci" },
    { "value": "nastolatkowie", "label": "Nastolatkowie" },
    { "value": "mlodzi_dorosli", "label": "Młodzi dorośli" },
    { "value": "dorosli", "label": "Dorośli" },
    { "value": "osoby_starsze", "label": "Osoby starsze" }
  ]
}
```

## 3. Authentication and Authorization

### 3.1 Authentication Model

**Technology:** Supabase Auth (Client-Side Authentication)

**Important:** This application uses Supabase Auth exclusively for authentication. All authentication operations (registration, login, logout, password management, account deletion) are handled **client-side** using the Supabase JavaScript SDK (`@supabase/supabase-js`).

**Backend API Role:**
- The backend API endpoints **do not** implement authentication endpoints
- Backend only **verifies** JWT tokens issued by Supabase Auth
- Token verification is done via `supabase.auth.getUser()` in API routes

**Client-Side Authentication Flow:**

**Registration:**
```typescript
const { data, error } = await supabase.auth.signUp({
  email: 'user@example.com',
  password: 'securepassword123'
})
```

**Login:**
```typescript
const { data, error } = await supabase.auth.signInWithPassword({
  email: 'user@example.com',
  password: 'securepassword123'
})
```

**Logout:**
```typescript
const { error } = await supabase.auth.signOut()
```

**Password Change:**
```typescript
const { error } = await supabase.auth.updateUser({
  password: 'newsecurepassword123'
})
```

**Account Deletion:**
```typescript
// Requires custom implementation calling Supabase Management API
// or backend endpoint that uses service role key
```

**Session Management:**
- JWT tokens automatically managed by Supabase SDK
- Access tokens expire after 1 hour (configurable in Supabase)
- Refresh tokens used for automatic session renewal
- Tokens stored in localStorage/sessionStorage by SDK
- SDK automatically adds `Authorization: Bearer <token>` header

### 3.2 Backend Token Verification

Backend API routes verify tokens using:

```typescript
const supabase = context.locals.supabase;
const { data: { user }, error } = await supabase.auth.getUser();

if (error || !user) {
  // Return 401 Unauthorized
}
```

### 3.3 Authorization Rules

#### Guest Users (Unauthenticated)
- **Can:** Generate event descriptions (POST /api/events)
- **Cannot:** Save, edit, or rate events
- Events created by guests have `created_by_authenticated_user = false` and `user_id = null`

#### Authenticated Users
- **Can:** All guest permissions plus:
  - Save events (PATCH /api/events/:id with `saved: true`)
  - Rate events (PATCH /api/events/:id with `feedback`)
  - Edit event descriptions (PATCH /api/events/:id with `edited_description`)
  - View saved events (GET /api/events?saved=true)
  - Delete saved events (DELETE /api/events/:id)
  - Manage account via Supabase Auth client SDK (change password, delete account)

### 3.4 Row Level Security (RLS)

Database-level security policies ensure:
- Users can only access their own events (WHERE user_id = auth.uid())
- Events with `user_id = null` are not accessible via GET endpoints
- UPDATE and DELETE operations restricted to event owner
- Activity logs are write-only from application perspective

### 3.5 Request Authentication Format

**Header Format:**
```
Authorization: Bearer <jwt_access_token>
```

**Token Validation:**
- Tokens are issued and signed by Supabase Auth
- Backend verifies JWT signature using Supabase client
- Verification happens via `supabase.auth.getUser()` method
- User ID extracted from verified token for RLS policies
- Invalid or expired tokens result in 401 Unauthorized response

## 4. Validation and Business Logic

### 4.1 Input Validation Rules

#### Events Resource

| Field | Validation Rules |
|-------|-----------------|
| title | Required, max 100 characters |
| city | Required, max 50 characters |
| event_date | Required, must be valid date format |
| category | Required, must be valid event_category enum |
| age_category | Required, must be valid age_category enum |
| key_information | Required, max 200 characters |
| edited_description | Optional, max 500 characters |
| saved | Boolean, default false |
| feedback | Optional, must be "thumbs_up" or "thumbs_down" |

### 4.2 Business Logic Implementation

#### Event Generation Flow
1. Validate input data against schema constraints
2. Check if user is authenticated (set `created_by_authenticated_user` flag)
3. Call AI service with validated input
4. Apply 500-character limit to generated description
5. Store event with `model_version` metadata
6. Log action in `event_management_logs` (action_type: 'event_created')
7. Return complete event object

#### Event Save Flow
1. Verify user is authenticated (403 if guest user)
2. Check event ownership (user_id matches authenticated user)
3. Update `saved` field to true
4. Log action in `event_management_logs` (action_type: 'event_saved')
5. Return updated event

#### Event Rating Flow
1. Verify user is authenticated (403 if guest user)
2. Check event ownership (user_id matches authenticated user)
3. Validate feedback value (thumbs_up or thumbs_down)
4. Check if event already has feedback (prevent duplicate ratings)
5. Update `feedback` field
6. Log action in `event_management_logs` (action_type: 'event_rated')
7. Use feedback data for AI model improvement metrics
8. Return updated event

#### Event Edit Flow
1. Verify user is authenticated (403 if guest user)
2. Check event ownership
3. Validate edited_description (max 500 chars)
4. Keep `generated_description` unchanged (historical record)
5. Update `edited_description` field
6. Log action in `event_management_logs` (action_type: 'event_edited')
7. Update `updated_at` timestamp via trigger
8. Return updated event

#### Event Soft Delete Flow
1. Verify user is authenticated
2. Check event ownership
3. Set `saved` field to false (soft delete)
4. Log action in `event_management_logs` (action_type: 'event_deleted')
5. Keep event in database for analytics
6. Return success message

#### Account Deletion Flow
1. User calls Supabase Auth client SDK to delete account
2. Supabase triggers CASCADE delete on `auth.users`
3. Database ON DELETE CASCADE sets `user_id = NULL` in user's events
4. Events remain in database for analytics (preserved with `created_by_authenticated_user = true`)
5. User sessions automatically invalidated by Supabase
6. Optional: Log action in `user_activity_logs` via database trigger

### 4.3 Error Handling

#### Validation Errors (400 Bad Request)
```json
{
  "error": "Validation failed",
  "details": [
    {
      "field": "key_information",
      "message": "Maximum length is 200 characters"
    }
  ]
}
```

#### Authentication Errors (401 Unauthorized)
```json
{
  "error": "Authentication required",
  "message": "Invalid or expired token"
}
```

#### Authorization Errors (403 Forbidden)
```json
{
  "error": "Forbidden",
  "message": "Cannot modify event created by guest user"
}
```

#### Not Found Errors (404 Not Found)
```json
{
  "error": "Not found",
  "message": "Event not found or doesn't belong to user"
}
```

#### Server Errors (500 Internal Server Error)
```json
{
  "error": "Internal server error",
  "message": "An unexpected error occurred"
}
```

### 4.4 AI Generation Constraints

**Strict Rules:**
- Use ONLY user-provided input data
- No web searches or external data fetching
- No hallucinated facts (dates, times, prices, addresses, performer names)
- Maximum 500 characters output
- Polish language only
- Preserve event category and age category context
- Generic, non-factographic language for category-specific details

**Prompt Template:**
```
Generate a concise event description in Polish (max 500 characters) based ONLY on this information:
- Title: {title}
- City: {city}
- Date: {event_date}
- Category: {category}
- Age Category: {age_category}
- Key Information: {key_information}

Do not add any facts not provided above (no prices, times, addresses, or performer details).
Use engaging but generic language appropriate for {category} and {age_category}.
```

### 4.5 Rate Limiting

**Recommendations:**
- 100 requests per hour per IP for unauthenticated users
- 1000 requests per hour per user for authenticated users
- 10 event generations per hour for unauthenticated users
- 50 event generations per hour for authenticated users

**Headers:**
```
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 95
X-RateLimit-Reset: 1697542800
```

### 4.6 Pagination

**Default Values:**
- Page size: 20 items
- Maximum page size: 100 items
- Default sort: created_at DESC

**Response Format:**
```json
{
  "data": [...],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 145,
    "total_pages": 8,
    "has_next": true,
    "has_prev": false
  }
}
```

## 5. API Versioning

**Strategy:** URL versioning

**Format:** `/api/v1/...`

**Current Version:** v1 (implicit, no version in URL for MVP)

**Future Considerations:**
- Introduce explicit versioning when breaking changes are needed
- Maintain backward compatibility for at least 6 months
- Deprecation notices in response headers

## 6. CORS Configuration

**Allowed Origins:**
- Development: `http://localhost:4321`, `http://localhost:3000`
- Production: `https://culturallyai.com`, `https://www.culturallyai.com`

**Allowed Methods:** GET, POST, PATCH, DELETE, OPTIONS

**Allowed Headers:** Authorization, Content-Type

**Credentials:** Include (for cookie-based auth if needed)

## 7. Logging and Monitoring

### 7.1 Audit Logs

**User Activity Logs:**
- account_created
- account_deleted
- password_changed
- login
- logout

**Event Management Logs:**
- event_created
- event_saved
- event_edited
- event_deleted (soft delete)
- event_rated

### 7.2 Metrics to Track

**Performance Metrics:**
- API response times (p50, p95, p99)
- AI generation latency
- Database query performance

**Business Metrics:**
- Events generated per day/week
- Save rate (saved events / total generated)
- Feedback ratio (thumbs_up / total feedback)
- Active users (daily/weekly/monthly)
- Events per user

**Error Metrics:**
- 4xx error rate by endpoint
- 5xx error rate by endpoint
- AI generation failures
- Authentication failures

## 8. API Response Format Standards

### 8.1 Success Responses

**Single Resource:**
```json
{
  "id": "uuid",
  "field1": "value1",
  "field2": "value2"
}
```

**Collection:**
```json
{
  "data": [...],
  "pagination": {...}
}
```

**Action Confirmation:**
```json
{
  "message": "Action completed successfully",
  "id": "uuid"
}
```

### 8.2 Error Responses

**Standard Format:**
```json
{
  "error": "Error type",
  "message": "Human-readable message",
  "details": [...] // Optional, for validation errors
}
```

### 8.3 Date/Time Format

**Standard:** ISO 8601 with timezone
```
2025-10-17T10:30:00Z
```

### 8.4 UUID Format

**Standard:** UUID v4
```
550e8400-e29b-41d4-a716-446655440000
```
